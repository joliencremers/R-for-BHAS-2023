---
title: "Exercises for packages and reading external data"
output: webexercises::webexercises_default
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(webexercises)
```

## 1. Introduction
In this exercise we will learn to use packages and write data to/from external sources

## 2. Packages

### Exercise 2.1 
Install the package called `RSQLite` using the console and skim the console-output. 

`r hide("Hint")`

To install packages we use the function `install.packages`  

`r unhide()`

`r hide("Answer")`
 
```{r eval = FALSE}
install.packages("RSQLite")
```

There is a lot of text in the output, including the website where the package is fetched from and
the path it is installed to. If the package depended on other packages they would
also be shown here. If the package is already installed and up-to-date it will
not be installed again, but a short piece of information will be shown here.

`r unhide()`



### Exercise 2.2 

Load the package `dplyr` and read the output in the console. What do you think it means?

`r hide("Hint")`

 We load a package with the function `library`

`r unhide()`

`r hide("Answer")`
 
```{r message = TRUE}
library(dplyr)
```

It informs us that dplyr is masking the functions `filter` and `lag` from the 
package `stats`. This is because there is a naming conflict. Both `dplyr` and 
`stats` has functions by those names, so when you write `filter` in the console
`R` does not know which one to choose. To avoid this the latest package you loaded
masks the others, so in this case when you write `filter` it will use the function 
from the `dplyr` package.  
To be helpful `library` prints this informational message to avoid confusion.

`r unhide()`



### Exercise 2.3  

Open the vignette for the package `DBI`. If you do not have it installed, do so. This might come in handy later.

```{r eval = FALSE, webex.hide="Answer"}
browseVignettes("DBI")
```

## 3. reading and writing data
### Exercise 3.1 

Together with 3-4 colleagues make a dataframe with three columns. One column should be a character column with your names. The second column should be a numeric column with your shoe size. The third column should be a logical column with `TRUE` if you have used `R` before and `FALSE` if you have not. Assign the dataframe to a name you choose yourselves.

`r hide("Hint")`

To create the dataframe use the function `data.frame`.

`r unhide()`

`r hide("Answer")`
 
Speak with your colleagues to get values for your dataframe.
```{r}
personal_data <- data.frame(names = c("Morten", "Philip", "Karen", "Emil"),
                            shoe_size = c(45, 46, 41, 42),
                            used_r = c(TRUE, TRUE, TRUE, TRUE))
```
Here it is possible to create problems with the names. Spaces should be avoided and
it is a convention to use *snakecase* (words seperated by _).

`r unhide()`



### Exercise 3.2
Write your dataframe to an excel-file (.xlsx).

`r hide("Hint")`

Use the function `write.xlsx` from the package `openxlsx`.

`r unhide()`

```{r, webex.hide="Answer"}
library(openxlsx)
openxlsx::write.xlsx(personal_data,
                     "personal_file.xlsx")
```

### Exercise 3.3

Open your file in Excel and edit a value. Save it and load it back into R. Does it look like you expected?

`r hide("Answer")`
 
Hopefully you have excel installed, else this exercise will is difficult. But
you can read the data into R using the function `read.xlsx`.
```{r}
read.xlsx("personal_file.xlsx")
```

As you can see the logical column has switched from logical to character. This
is a classical problem when switching between formats. In this case it is because
Excel doesn't recognise R's logical datatype. It is always a good idea
to check your data when reading from external sources.

`r unhide()`



## 4. Databases
### Exercise 4.1 

Open a connection to a SQLite database on a (shared) drive and give it a unique name. Warning: Be sure not to overwrite each others databases. Give it a name that makes it clear it is yours.

`r hide("Answer")`
 
 First you should find the path to the (shared) drive, we will determine this name together before we start the exercises. For this example we will assume the path is `"H:/"`  

Once you have the path you need a unique name for your database. Could for instance be your name and two numbers: `"peter23.sqlite"`.  

The database will automatically be created when we try to connect to it.
Use the function `dbConnect` to from the package `DBI` to open the connection:
```{r eval = F}
library(DBI)
con <- dbConnect(drv = RSQLite::SQLite(),
                 dbname = "H:/peter23.sqlite")
```

`r unhide()`


### Exercise 4.2

Write the dataset to your database using the functions from the lecture. Check that a table is actually created in the database.

`r hide("Hint")`

Use the function `dbWriteTable`. Check the help page for the function to see the arguments.

`r unhide()`

`r hide("Answer")`
 
```{r eval = F}
dbWriteTable(conn = con,
             name = "my_tablename",
             value = personal_data)
```

`dbWriteTable` just returns a logical value `TRUE` if it succeeded. But to make 
sure that the table with our data has been created, use the function `dbListTables`
```{r eval = F}
dbListTables(con)
```
```{r echo=F}
c("my_tablename")
```

If the name of your table does not show up, something went wrong.


`r unhide()`


### Exercise 4.3 
Read the dataset from the database back into R and inspect it. Does it look like you expected? 

`r hide("Hint")`

Use the function `dbReadTable`.

`r unhide()`

`r hide("Answer")`
 
The function `dbReadTable` takes two required
arguments: A connection to a database and the name of the table you want to read:
```{r eval=F}
personal_data_from_db <- dbReadTable(conn = con,
                                     name = "my_tablename")
```

Inspect the data either by printing it in the console or use the `View`-function.
You will see that once again, the logical column has changed datatype. This time
to a numeric/integer.

`r unhide()`


### Exercise 4.4 
Disconnect from your database

`r hide("Hint")`

Use the function `dbDisconnect`.

`r unhide()`


`r hide("Answer")`
 
```{r eval = F}
dbDisconnect(con)
```

`r unhide()`

***
**Note:**

**The following exercises work best if you created the database on a shared drive. If not, skip Exercise 4.5 and in Exercise 4.6, create a new table (like in Exercise 3.1 but with new values) and append this to the table you just saved to the database in Exercise 4.2.**

***

### Exercise 4.5 

Ask another group for the path to their database and open a connection to it. Use this connection to show the name of their table.

`r hide("Answer")`
 
If the other group named their database `"H:/anna93.sqlite"` then you can connect to it just like if it was your own, so you can reuse your code from exercise 7:
```{r eval = F}
con2 <- dbConnect(RSQLite::SQLite(),
                  dbname = "H:/anna93.sqlite")
dbListTables(con2)
```
```{r echo = F}
c("their_table_name")
```

`r unhide()`



### Exercise 4.6

Append your own dataset to the other groups table (your own if you're not working on a shared drive). Appending is when you add your data the existing data. Read the help-file for `dbWriteTable` to see how it is done. Close the connection when you are done.

`r hide("Answer")`
 
The first thing you have to do is make your (new) dataset look like theirs (your old one). They may have used different names for their columns, so start by reading their table and inspecting it using the tablename you found in Exercise 4.5.
```{r eval = F}
their_data <- dbReadTable(con2, "their_table_name")
View(their_data)
```

Now rename your dataframe so it matches theirs. This can be done using the `names` function
```{r eval = F}
names(personal_data) <- c("Their", "column", "names") ##Remember R is casesensitive!
```

Now you should be able to add your dataset to their table:
```{r eval = FALSE}
dbWriteTable(conn = con2, 
             name = "their_table_name", 
             value = personal_data, 
             append = TRUE)
```

Disconnect from their database
```{r eval = FALSE}
dbDisconnect(con2)
```

`r unhide()`



### Exercise 4.7

Reopen the connection to your own database and read your table. Can you see the new data that has been added?

`r hide("Answer")`

Use the same code you made in Exercise 4.1 and 4.3. If the other group successfully appended their dataset, you should see more rows than you did earlier.

`r unhide()`



### Exercise 4.8

If you have more time, try making an SQL-query to select only the data where shoe size is greater than 40.

## Reading your own data

### Exercise 5
Try to read some of your own data that you have worked with or are currently working with (for example an Excel file) into R. Check if the data is read correctly (check datatypes, missing values, etc.) 
